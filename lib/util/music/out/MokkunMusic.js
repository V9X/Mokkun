"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_js_1 = require("discord.js");
const ytdl_core_discord_1 = __importDefault(require("ytdl-core-discord"));
const yts_1 = __importDefault(require("@caier/yts"));
const v4_1 = __importDefault(require("uuid/v4"));
const sc_1 = __importDefault(require("@caier/sc"));
const errors_1 = require("../../errors/out/errors");
class MusicEntry {
    constructor(opts) {
        this.id = v4_1.default();
        this.addedOn = Date.now();
        this.addedBy = opts.member;
        this.queue = opts.queue;
        this.type = opts.type;
        this.videoInfo = opts.vid;
    }
    get strTime() {
        var _a, _b;
        return (_b = (_a = this.dispatcher) === null || _a === void 0 ? void 0 : _a.streamTime) !== null && _b !== void 0 ? _b : 0;
    }
    get milisLeft() {
        return this.videoInfo.milis - this.strTime;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
}
exports.MusicEntry = MusicEntry;
class MusicQueue {
    constructor() {
        this.queue = [];
        this.history = [];
        this.playing = null;
    }
    addEntry(entry, VoiceC, top) {
        this.VoiceCon = VoiceC;
        if (top)
            this.queue.unshift(entry);
        else
            this.queue.push(entry);
        if (!this.playing)
            this._playNext();
        else
            this._announce('addedToQueue', entry);
    }
    _playNext() {
        if (this.queue.length > 0) {
            if (this.playing)
                this.history.push(this.playing);
            this.playing = this.queue.shift();
            this.play(this.playing);
            this._announce('nextSong');
        }
        else
            this._finish();
    }
    async play(entry, retries = 0) {
        var _a, _b, _c, _d;
        if (this.VoiceCon.status != '0')
            throw Error('VoiceConnection is not ready');
        let str;
        if (entry.type == 'yt')
            str = await MokkunMusic.getYTStream(entry.videoInfo.url);
        else if (entry.type == 'sc')
            str = await sc_1.default.download(entry.videoInfo.id, true);
        str.on('end', () => setTimeout(() => this._playNext(), 2000));
        this.playing.dispatcher = this.VoiceCon.play(str, { type: 'opus', highWaterMark: 1 });
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.setFEC(true);
        if (!((_c = this.playing) === null || _c === void 0 ? void 0 : _c.dispatcher)) {
            (_d = str) === null || _d === void 0 ? void 0 : _d.destroy();
            if (retries > 2) {
                this._playNext();
                throw new errors_1.LoggedError(this.outChannel, "Cannot attach StreamDispatcher");
            }
            await new Promise(r => setTimeout(() => this.play(entry, retries + 1) && r(), 1000));
        }
    }
    _finish() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause) === null || _c === void 0 ? void 0 : _c.call(_b);
        if (this.playing)
            this.history.push(this.playing);
        this.playing = null;
        this.destTimer = setTimeout(() => {
            if (!this.playing)
                this.VoiceCon.disconnect();
        }, 600000);
    }
    set destTimer(timer) {
        this.timer && clearTimeout(this.timer);
        this.timer = timer;
    }
    _announce(what, entry, ret) {
        var _a, _b, _c;
        if (!this.outChannel)
            throw Error('Announement channel is not specified');
        let embed = new discord_js_1.MessageEmbed().setColor((entry === null || entry === void 0 ? void 0 : entry.type) == 'sc' ? '#ff8800' : [112, 0, 55]);
        if (what == 'nextSong') {
            let pl = this.playing;
            embed.setAuthor('NastÄ™pny utwÃ³r ðŸŽµ')
                .setColor((pl === null || pl === void 0 ? void 0 : pl.type) == 'sc' ? '#ff8800' : [112, 0, 55])
                .setDescription(`**[${pl.videoInfo.name}](${pl.videoInfo.url})**`)
                .setThumbnail(pl.videoInfo.thumbnail)
                .addField("KanaÅ‚", pl.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", pl.videoInfo.duration, true)
                .addField("Dodano przez", pl.addedBy.user.username, true)
                .addField("NastÄ™pnie", (_b = (_a = this.queue[0]) === null || _a === void 0 ? void 0 : _a.videoInfo.name) !== null && _b !== void 0 ? _b : 'brak');
        }
        else if (what == 'addedToQueue') {
            let entry = arguments[1];
            let pos = this.queue.findIndex(v => v.id == entry.id) + 1;
            embed.setAuthor('Dodano do kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail)
                .addField("KanaÅ‚", entry.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", entry.videoInfo.duration, true)
                .addField("Za", pos == 1 ? (_c = this.playing) === null || _c === void 0 ? void 0 : _c.timeLeft : this.timeLeft, true)
                .addField("Pozycja", pos);
        }
        else if (what == 'removed') {
            let entry = arguments[1];
            embed.setAuthor('UsuniÄ™to z kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail);
        }
        if (ret)
            return embed;
        this.outChannel.send(embed);
    }
    get milisLeft() {
        var _a, _b;
        let len = (((_a = this.playing) === null || _a === void 0 ? void 0 : _a.videoInfo.milis) || 0) - (((_b = this.playing) === null || _b === void 0 ? void 0 : _b.strTime) || 0);
        for (let ent of this.queue.slice(0, -1))
            len += ent.videoInfo.milis;
        return len;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
    pause() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause();
    }
    resume() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.resume();
    }
    remove(pos) {
        if (!(/^[1-9]\d*$/).test(pos) || !this.queue[+pos - 1]) {
            return false;
        }
        this._announce('removed', this.queue.splice(+pos - 1, 1)[0]);
        return true;
    }
    setOutChan(chan) {
        this.outChannel = chan;
        return this;
    }
    get status() {
        var _a, _b, _c;
        return ((_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.paused) ? 'paused' : ((_c = this.playing) === null || _c === void 0 ? void 0 : _c.dispatcher) ? 'playing' : 'idle';
    }
}
exports.MusicQueue = MusicQueue;
class MokkunMusic {
    constructor() {
        this.queues = new discord_js_1.Collection();
    }
    getQueue(guild) {
        let q = this.queues.get(guild.id);
        if (!q) {
            q = new MusicQueue();
            this.queues.set(guild.id, q);
        }
        return q;
    }
    searchVideos(query) {
        return yts_1.default(query);
    }
    searchSC(query) {
        return sc_1.default.search(query);
    }
    static getYTStream(url) {
        return ytdl_core_discord_1.default(url, { quality: 'highestaudio', highWaterMark: 1 << 25 });
    }
    destroyQueue(guildid) {
        this.queues.delete(guildid);
    }
}
exports.MokkunMusic = MokkunMusic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9ra3VuTXVzaWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvTW9ra3VuTXVzaWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FBeUc7QUFHekcsMEVBQXFDO0FBQ3JDLHFEQUE2QjtBQUU3QixpREFBMkI7QUFDM0IsbURBQTJCO0FBRTNCLG9EQUFzRDtBQUd0RCxNQUFhLFVBQVU7SUFTbkIsWUFBWSxJQUE2RjtRQVJ6RyxPQUFFLEdBQVcsWUFBSSxFQUFFLENBQUM7UUFDcEIsWUFBTyxHQUFXLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQVF6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDM0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDOUIsQ0FBQztJQUVELElBQUksT0FBTzs7UUFDUCxtQkFBTyxJQUFJLENBQUMsVUFBVSwwQ0FBRSxVQUFVLG1DQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsSUFBSSxTQUFTO1FBQ1QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQy9DLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDUixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN4RixDQUFDO0NBQ0o7QUEzQkQsZ0NBMkJDO0FBRUQsTUFBYSxVQUFVO0lBQXZCO1FBRUksVUFBSyxHQUFpQixFQUFFLENBQUM7UUFDekIsWUFBTyxHQUFpQixFQUFFLENBQUM7UUFFM0IsWUFBTyxHQUFzQixJQUFJLENBQUM7SUF3SXRDLENBQUM7SUFySUcsUUFBUSxDQUFDLEtBQWlCLEVBQUUsTUFBdUIsRUFBRSxHQUFZO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLElBQUcsR0FBRztZQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDOztZQUUxQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixJQUFHLENBQUMsSUFBSSxDQUFDLE9BQU87WUFDWixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7O1lBRWpCLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxTQUFTO1FBQ0wsSUFBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdEIsSUFBRyxJQUFJLENBQUMsT0FBTztnQkFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBZ0IsQ0FBQztZQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzlCOztZQUVHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU8sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFpQixFQUFFLE9BQU8sR0FBRyxDQUFDOztRQUM3QyxJQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLEdBQUc7WUFDMUIsTUFBTSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztRQUNoRCxJQUFJLEdBQUcsQ0FBQztRQUNSLElBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJO1lBQ2pCLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN4RCxJQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSTtZQUN0QixHQUFHLEdBQUcsTUFBTSxZQUFFLENBQUMsUUFBUSxDQUFFLEtBQUssQ0FBQyxTQUF3QixDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxRCxHQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLE9BQVEsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQztRQUNuRyxZQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLFVBQVUsMENBQUUsTUFBTSxDQUFDLElBQUksRUFBRTtRQUN2QyxJQUFHLFFBQUMsSUFBSSxDQUFDLE9BQU8sMENBQUUsVUFBVSxDQUFBLEVBQUU7WUFDMUIsTUFBWSxHQUFJLDBDQUFFLE9BQU8sR0FBRztZQUM1QixJQUFHLE9BQU8sR0FBRyxDQUFDLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNqQixNQUFNLElBQUksb0JBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGdDQUFnQyxDQUFDLENBQUM7YUFDNUU7WUFDRCxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE9BQU8sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ3hGO0lBQ0wsQ0FBQztJQUVPLE9BQU87O1FBQ1gsa0JBQUEsSUFBSSxDQUFDLE9BQU8sMENBQUUsVUFBVSwwQ0FBRSxLQUFLLG1EQUFLO1FBQ3BDLElBQUcsSUFBSSxDQUFDLE9BQU87WUFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQzdCLElBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTztnQkFDWixJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ25DLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNmLENBQUM7SUFFRCxJQUFZLFNBQVMsQ0FBQyxLQUFxQjtRQUN2QyxJQUFJLENBQUMsS0FBSyxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztJQUVELFNBQVMsQ0FBQyxJQUF5QyxFQUFFLEtBQWtCLEVBQUUsR0FBYTs7UUFDbEYsSUFBRyxDQUFDLElBQUksQ0FBQyxVQUFVO1lBQ2YsTUFBTSxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQztRQUN4RCxJQUFJLEtBQUssR0FBRyxJQUFJLHlCQUFZLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsSUFBSSxLQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RixJQUFHLElBQUksSUFBSSxVQUFVLEVBQUU7WUFDbkIsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQXFCLENBQUM7WUFDcEMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQztpQkFDbkMsUUFBUSxDQUFDLENBQUEsRUFBRSxhQUFGLEVBQUUsdUJBQUYsRUFBRSxDQUFFLElBQUksS0FBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2lCQUNyRCxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDO2lCQUNqRSxZQUFZLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7aUJBQ3BDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztpQkFDakQsUUFBUSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUM7aUJBQ2hELFFBQVEsQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztpQkFDeEQsUUFBUSxDQUFDLFdBQVcsY0FBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQywwQ0FBRSxTQUFTLENBQUMsSUFBSSxtQ0FBSSxNQUFNLENBQUMsQ0FBQztTQUNuRTthQUNJLElBQUcsSUFBSSxJQUFJLGNBQWMsRUFBRTtZQUM1QixJQUFJLEtBQUssR0FBZ0IsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzFELEtBQUssQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUM7aUJBQ25DLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUM7aUJBQ3ZFLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQztpQkFDdkMsUUFBUSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO2lCQUNwRCxRQUFRLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztpQkFDbkQsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBQyxJQUFJLENBQUMsT0FBTywwQ0FBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDO2lCQUN2RSxRQUFRLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzdCO2FBQ0ksSUFBRyxJQUFJLElBQUksU0FBUyxFQUFFO1lBQ3ZCLElBQUksS0FBSyxHQUFnQixTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQztpQkFDcEMsY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQztpQkFDdkUsWUFBWSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUE7U0FDM0M7UUFDRCxJQUFHLEdBQUc7WUFDRixPQUFPLEtBQUssQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsSUFBSSxTQUFTOztRQUNULElBQUksR0FBRyxHQUFHLENBQUMsT0FBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxTQUFTLENBQUMsS0FBSyxLQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxPQUFPLEtBQUksQ0FBQyxDQUFDLENBQUM7UUFDOUUsS0FBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbEMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQy9CLE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQztJQUVELElBQUksUUFBUTtRQUNSLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFRCxLQUFLOztRQUNELFlBQUEsSUFBSSxDQUFDLE9BQU8sMENBQUUsVUFBVSwwQ0FBRSxLQUFLLEdBQUc7SUFDdEMsQ0FBQztJQUVELE1BQU07O1FBQ0YsWUFBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxVQUFVLDBDQUFFLE1BQU0sR0FBRztJQUN2QyxDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQVc7UUFDZCxJQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2pELE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEdBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFpQjtRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsSUFBSSxNQUFNOztRQUNOLE9BQU8sYUFBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxVQUFVLDBDQUFFLE1BQU0sRUFBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLFVBQVUsRUFBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkcsQ0FBQztDQUNKO0FBN0lELGdDQTZJQztBQUVELE1BQWEsV0FBVztJQUF4QjtRQUNZLFdBQU0sR0FBRyxJQUFJLHVCQUFVLEVBQXNCLENBQUM7SUEwQjFELENBQUM7SUF4QkcsUUFBUSxDQUFDLEtBQVk7UUFDakIsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLElBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDSCxDQUFDLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2hDO1FBQ0QsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQWE7UUFDdEIsT0FBTyxhQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELFFBQVEsQ0FBQyxLQUFhO1FBQ2xCLE9BQU8sWUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFXO1FBQzFCLE9BQU8sMkJBQUksQ0FBQyxHQUFHLEVBQUUsRUFBQyxPQUFPLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxDQUFDLElBQUUsRUFBRSxFQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsWUFBWSxDQUFDLE9BQWU7UUFDeEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNKO0FBM0JELGtDQTJCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbGxlY3Rpb24sIFRleHRDaGFubmVsLCBNZXNzYWdlRW1iZWQsIEd1aWxkLCBHdWlsZE1lbWJlciwgU3RyZWFtRGlzcGF0Y2hlciB9IGZyb20gJ2Rpc2NvcmQuanMnO1xyXG4vLyBAdHMtaWdub3JlXHJcbmltcG9ydCBWb2ljZUNvbm5lY3Rpb24gZnJvbSAnZGlzY29yZC5qcy9zcmMvY2xpZW50L3ZvaWNlL1ZvaWNlQ29ubmVjdGlvbic7XHJcbmltcG9ydCB5dGRsIGZyb20gJ3l0ZGwtY29yZS1kaXNjb3JkJztcclxuaW1wb3J0IHl0cyBmcm9tICdAY2FpZXIveXRzJztcclxuaW1wb3J0IHsgVmlkZW9FbnRyeSB9IGZyb20gJ0BjYWllci95dHMvbGliL2ludGVyZmFjZXMnO1xyXG5pbXBvcnQgdXVpZCBmcm9tICd1dWlkL3Y0JztcclxuaW1wb3J0IHNjIGZyb20gJ0BjYWllci9zYyc7XHJcbmltcG9ydCB7IFRyYWNrRW50cnkgfSBmcm9tICdAY2FpZXIvc2Mvb3V0L2ludGVyZmFjZXMnO1xyXG5pbXBvcnQgeyBMb2dnZWRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycy9vdXQvZXJyb3JzJztcclxuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tICdzdHJlYW0nO1xyXG5cclxuZXhwb3J0IGNsYXNzIE11c2ljRW50cnkge1xyXG4gICAgaWQ6IHN0cmluZyA9IHV1aWQoKTtcclxuICAgIGFkZGVkT246IG51bWJlciA9IERhdGUubm93KCk7XHJcbiAgICBhZGRlZEJ5OiBHdWlsZE1lbWJlcjtcclxuICAgIHF1ZXVlOiBNdXNpY1F1ZXVlO1xyXG4gICAgdHlwZTogXCJ5dFwifFwic2NcIjtcclxuICAgIHZpZGVvSW5mbzogVmlkZW9FbnRyeSB8IFRyYWNrRW50cnk7XHJcbiAgICBkaXNwYXRjaGVyPzogU3RyZWFtRGlzcGF0Y2hlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzOiB7dmlkOiBWaWRlb0VudHJ5IHwgVHJhY2tFbnRyeSwgbWVtYmVyOiBHdWlsZE1lbWJlciwgcXVldWU6IE11c2ljUXVldWUsIHR5cGU6IFwieXRcInxcInNjXCJ9KSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZEJ5ID0gb3B0cy5tZW1iZXI7XHJcbiAgICAgICAgdGhpcy5xdWV1ZSA9IG9wdHMucXVldWU7XHJcbiAgICAgICAgdGhpcy50eXBlID0gb3B0cy50eXBlO1xyXG4gICAgICAgIHRoaXMudmlkZW9JbmZvID0gb3B0cy52aWQ7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldCBzdHJUaW1lKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXI/LnN0cmVhbVRpbWUgPz8gMDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWlsaXNMZWZ0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnZpZGVvSW5mby5taWxpcyAtIHRoaXMuc3RyVGltZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZUxlZnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMubWlsaXNMZWZ0KS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAtNSkucmVwbGFjZSgvXjArOj8wPy9nLCAnJyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBNdXNpY1F1ZXVlIHtcclxuICAgIHByaXZhdGUgdGltZXI/OiBOb2RlSlMuVGltZW91dDtcclxuICAgIHF1ZXVlOiBNdXNpY0VudHJ5W10gPSBbXTtcclxuICAgIGhpc3Rvcnk6IE11c2ljRW50cnlbXSA9IFtdO1xyXG4gICAgVm9pY2VDb246IFZvaWNlQ29ubmVjdGlvbjtcclxuICAgIHBsYXlpbmc6IE11c2ljRW50cnkgfCBudWxsID0gbnVsbDtcclxuICAgIG91dENoYW5uZWw/OiBUZXh0Q2hhbm5lbDtcclxuXHJcbiAgICBhZGRFbnRyeShlbnRyeTogTXVzaWNFbnRyeSwgVm9pY2VDOiBWb2ljZUNvbm5lY3Rpb24sIHRvcDogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuVm9pY2VDb24gPSBWb2ljZUM7XHJcbiAgICAgICAgaWYodG9wKVxyXG4gICAgICAgICAgICB0aGlzLnF1ZXVlLnVuc2hpZnQoZW50cnkpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKGVudHJ5KTtcclxuICAgICAgICBpZighdGhpcy5wbGF5aW5nKVxyXG4gICAgICAgICAgICB0aGlzLl9wbGF5TmV4dCgpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2UoJ2FkZGVkVG9RdWV1ZScsIGVudHJ5KTtcclxuICAgIH1cclxuXHJcbiAgICBfcGxheU5leHQoKSB7XHJcbiAgICAgICAgaWYodGhpcy5xdWV1ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGlmKHRoaXMucGxheWluZylcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5wdXNoKHRoaXMucGxheWluZyk7XHJcbiAgICAgICAgICAgIHRoaXMucGxheWluZyA9IHRoaXMucXVldWUuc2hpZnQoKSBhcyBNdXNpY0VudHJ5O1xyXG4gICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5wbGF5aW5nKTtcclxuICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2UoJ25leHRTb25nJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5fZmluaXNoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBwbGF5KGVudHJ5OiBNdXNpY0VudHJ5LCByZXRyaWVzID0gMCkge1xyXG4gICAgICAgIGlmKHRoaXMuVm9pY2VDb24uc3RhdHVzICE9ICcwJykgXHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdWb2ljZUNvbm5lY3Rpb24gaXMgbm90IHJlYWR5Jyk7XHJcbiAgICAgICAgbGV0IHN0cjtcclxuICAgICAgICBpZihlbnRyeS50eXBlID09ICd5dCcpXHJcbiAgICAgICAgICAgIHN0ciA9IGF3YWl0IE1va2t1bk11c2ljLmdldFlUU3RyZWFtKGVudHJ5LnZpZGVvSW5mby51cmwpO1xyXG4gICAgICAgIGVsc2UgaWYoZW50cnkudHlwZSA9PSAnc2MnKVxyXG4gICAgICAgICAgICBzdHIgPSBhd2FpdCBzYy5kb3dubG9hZCgoZW50cnkudmlkZW9JbmZvIGFzIFRyYWNrRW50cnkpLmlkLCB0cnVlKTtcclxuICAgICAgICAoPFJlYWRhYmxlPiBzdHIpLm9uKCdlbmQnLCAoKSA9PiBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3BsYXlOZXh0KCksIDIwMDApKTtcclxuICAgICAgICAoPE11c2ljRW50cnk+IHRoaXMucGxheWluZykuZGlzcGF0Y2hlciA9IHRoaXMuVm9pY2VDb24ucGxheShzdHIsIHt0eXBlOiAnb3B1cycsIGhpZ2hXYXRlck1hcms6IDF9KTtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnNldEZFQyh0cnVlKTtcclxuICAgICAgICBpZighdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyKSB7XHJcbiAgICAgICAgICAgICg8UmVhZGFibGU+IHN0cik/LmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgaWYocmV0cmllcyA+IDIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3BsYXlOZXh0KCk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTG9nZ2VkRXJyb3IodGhpcy5vdXRDaGFubmVsLCBcIkNhbm5vdCBhdHRhY2ggU3RyZWFtRGlzcGF0Y2hlclwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5wbGF5KGVudHJ5LCByZXRyaWVzICsgMSkgJiYgcigpLCAxMDAwKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2ZpbmlzaCgpIHtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnBhdXNlPy4oKTtcclxuICAgICAgICBpZih0aGlzLnBsYXlpbmcpXHJcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5wdXNoKHRoaXMucGxheWluZyk7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nID0gbnVsbDtcclxuICAgICAgICB0aGlzLmRlc3RUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZighdGhpcy5wbGF5aW5nKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5Wb2ljZUNvbi5kaXNjb25uZWN0KCk7IFxyXG4gICAgICAgIH0sIDYwMDAwMCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXQgZGVzdFRpbWVyKHRpbWVyOiBOb2RlSlMuVGltZW91dCkge1xyXG4gICAgICAgIHRoaXMudGltZXIgJiYgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpO1xyXG4gICAgICAgIHRoaXMudGltZXIgPSB0aW1lcjtcclxuICAgIH1cclxuXHJcbiAgICBfYW5ub3VuY2Uod2hhdDogJ25leHRTb25nJ3wnYWRkZWRUb1F1ZXVlJ3wncmVtb3ZlZCcsIGVudHJ5PzogTXVzaWNFbnRyeSwgcmV0PzogYm9vbGVhbikgOiB2b2lkIHwgTWVzc2FnZUVtYmVkIHtcclxuICAgICAgICBpZighdGhpcy5vdXRDaGFubmVsKVxyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcignQW5ub3VuZW1lbnQgY2hhbm5lbCBpcyBub3Qgc3BlY2lmaWVkJyk7XHJcbiAgICAgICAgbGV0IGVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpLnNldENvbG9yKGVudHJ5Py50eXBlID09ICdzYycgPyAnI2ZmODgwMCcgOiBbMTEyLCAwLCA1NV0pO1xyXG4gICAgICAgIGlmKHdoYXQgPT0gJ25leHRTb25nJykge1xyXG4gICAgICAgICAgICBsZXQgcGwgPSB0aGlzLnBsYXlpbmcgYXMgTXVzaWNFbnRyeTtcclxuICAgICAgICAgICAgZW1iZWQuc2V0QXV0aG9yKCdOYXN0xJlwbnkgdXR3w7NyIPCfjrUnKVxyXG4gICAgICAgICAgICAuc2V0Q29sb3IocGw/LnR5cGUgPT0gJ3NjJyA/ICcjZmY4ODAwJyA6IFsxMTIsIDAsIDU1XSlcclxuICAgICAgICAgICAgLnNldERlc2NyaXB0aW9uKGAqKlske3BsLnZpZGVvSW5mby5uYW1lfV0oJHtwbC52aWRlb0luZm8udXJsfSkqKmApXHJcbiAgICAgICAgICAgIC5zZXRUaHVtYm5haWwocGwudmlkZW9JbmZvLnRodW1ibmFpbClcclxuICAgICAgICAgICAgLmFkZEZpZWxkKFwiS2FuYcWCXCIsIHBsLnZpZGVvSW5mby5hdXRob3IubmFtZSwgdHJ1ZSlcclxuICAgICAgICAgICAgLmFkZEZpZWxkKFwiRMWCdWdvxZvEh1wiLCBwbC52aWRlb0luZm8uZHVyYXRpb24sIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkRvZGFubyBwcnplelwiLCBwbC5hZGRlZEJ5LnVzZXIudXNlcm5hbWUsIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIk5hc3TEmXBuaWVcIiwgdGhpcy5xdWV1ZVswXT8udmlkZW9JbmZvLm5hbWUgPz8gJ2JyYWsnKTtcclxuICAgICAgICB9IFxyXG4gICAgICAgIGVsc2UgaWYod2hhdCA9PSAnYWRkZWRUb1F1ZXVlJykge1xyXG4gICAgICAgICAgICBsZXQgZW50cnkgOiBNdXNpY0VudHJ5ID0gYXJndW1lbnRzWzFdO1xyXG4gICAgICAgICAgICBsZXQgcG9zID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgodiA9PiB2LmlkID09IGVudHJ5LmlkKSArIDE7XHJcbiAgICAgICAgICAgIGVtYmVkLnNldEF1dGhvcignRG9kYW5vIGRvIGtvbGVqa2knKVxyXG4gICAgICAgICAgICAuc2V0RGVzY3JpcHRpb24oYCoqWyR7ZW50cnkudmlkZW9JbmZvLm5hbWV9XSgke2VudHJ5LnZpZGVvSW5mby51cmx9KSoqYClcclxuICAgICAgICAgICAgLnNldFRodW1ibmFpbChlbnRyeS52aWRlb0luZm8udGh1bWJuYWlsKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJLYW5hxYJcIiwgZW50cnkudmlkZW9JbmZvLmF1dGhvci5uYW1lLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJExYJ1Z2/Fm8SHXCIsIGVudHJ5LnZpZGVvSW5mby5kdXJhdGlvbiwgdHJ1ZSlcclxuICAgICAgICAgICAgLmFkZEZpZWxkKFwiWmFcIiwgcG9zID09IDEgPyB0aGlzLnBsYXlpbmc/LnRpbWVMZWZ0IDogdGhpcy50aW1lTGVmdCwgdHJ1ZSlcclxuICAgICAgICAgICAgLmFkZEZpZWxkKFwiUG96eWNqYVwiLCBwb3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmKHdoYXQgPT0gJ3JlbW92ZWQnKSB7XHJcbiAgICAgICAgICAgIGxldCBlbnRyeSA6IE11c2ljRW50cnkgPSBhcmd1bWVudHNbMV07XHJcbiAgICAgICAgICAgIGVtYmVkLnNldEF1dGhvcignVXN1bmnEmXRvIHoga29sZWpraScpXHJcbiAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKipbJHtlbnRyeS52aWRlb0luZm8ubmFtZX1dKCR7ZW50cnkudmlkZW9JbmZvLnVybH0pKipgKVxyXG4gICAgICAgICAgICAuc2V0VGh1bWJuYWlsKGVudHJ5LnZpZGVvSW5mby50aHVtYm5haWwpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHJldClcclxuICAgICAgICAgICAgcmV0dXJuIGVtYmVkO1xyXG4gICAgICAgIHRoaXMub3V0Q2hhbm5lbC5zZW5kKGVtYmVkKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0IG1pbGlzTGVmdCgpIHtcclxuICAgICAgICBsZXQgbGVuID0gKHRoaXMucGxheWluZz8udmlkZW9JbmZvLm1pbGlzIHx8IDApIC0gKHRoaXMucGxheWluZz8uc3RyVGltZSB8fCAwKTtcclxuICAgICAgICBmb3IobGV0IGVudCBvZiB0aGlzLnF1ZXVlLnNsaWNlKDAsIC0xKSlcclxuICAgICAgICAgICAgbGVuICs9IGVudC52aWRlb0luZm8ubWlsaXM7XHJcbiAgICAgICAgcmV0dXJuIGxlbjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZUxlZnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMubWlsaXNMZWZ0KS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAtNSkucmVwbGFjZSgvXjArOj8wPy9nLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcGF1c2UoKSB7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3VtZSgpIHtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnJlc3VtZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZShwb3M6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgICAgICBpZighKC9eWzEtOV1cXGQqJC8pLnRlc3QocG9zKSB8fCAhdGhpcy5xdWV1ZVsrcG9zLTFdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fYW5ub3VuY2UoJ3JlbW92ZWQnLCB0aGlzLnF1ZXVlLnNwbGljZSgrcG9zLTEsIDEpWzBdKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRPdXRDaGFuKGNoYW46IFRleHRDaGFubmVsKSA6IE11c2ljUXVldWUge1xyXG4gICAgICAgIHRoaXMub3V0Q2hhbm5lbCA9IGNoYW47XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHN0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZWQgPyAncGF1c2VkJyA6IHRoaXMucGxheWluZz8uZGlzcGF0Y2hlciA/ICdwbGF5aW5nJyA6ICdpZGxlJztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE1va2t1bk11c2ljIHtcclxuICAgIHByaXZhdGUgcXVldWVzID0gbmV3IENvbGxlY3Rpb248c3RyaW5nLCBNdXNpY1F1ZXVlPigpO1xyXG5cclxuICAgIGdldFF1ZXVlKGd1aWxkOiBHdWlsZCkgOiBNdXNpY1F1ZXVlIHtcclxuICAgICAgICBsZXQgcSA9IHRoaXMucXVldWVzLmdldChndWlsZC5pZCk7XHJcbiAgICAgICAgaWYoIXEpIHtcclxuICAgICAgICAgICAgcSA9IG5ldyBNdXNpY1F1ZXVlKCk7XHJcbiAgICAgICAgICAgIHRoaXMucXVldWVzLnNldChndWlsZC5pZCwgcSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxO1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaFZpZGVvcyhxdWVyeTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHl0cyhxdWVyeSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoU0MocXVlcnk6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBzYy5zZWFyY2gocXVlcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBnZXRZVFN0cmVhbSh1cmw6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB5dGRsKHVybCwge3F1YWxpdHk6ICdoaWdoZXN0YXVkaW8nLCBoaWdoV2F0ZXJNYXJrOiAxPDwyNX0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlc3Ryb3lRdWV1ZShndWlsZGlkOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLnF1ZXVlcy5kZWxldGUoZ3VpbGRpZCk7XHJcbiAgICB9IFxyXG59Il19